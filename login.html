<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Login con Huella + Firebase (WebAuthn)</title>
    <style>
        /* Tus estilos existentes */
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #00c6ff, #0072ff);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .login-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            position: relative;
        }

        input:focus {
            border-color: #007bff;
            outline: none;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }

        .input-wrapper input {
            padding-right: 40px;
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .toggle-password svg {
            fill: #999;
            width: 100%;
            height: 100%;
        }

        .toggle-password:hover svg {
            fill: #333;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 20px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:hover {
            background-color: #0056b3;
        }

        p {
            margin-top: 20px;
            color: #666;
        }

        a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }

        a:hover {
            text-decoration: underline;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .modal-content h1 {
            margin-bottom: 20px;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 2;
        }

        .loading-overlay p {
            color: white;
            font-size: 18px;
            margin-top: 10px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .login-container {
                padding: 30px;
            }

            h1 {
                font-size: 24px;
            }

            input, button {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* Estilos para el botón de Google */
        .google-login-btn {
            width: 100%;
            padding: 15px;
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-top: 10px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .google-login-btn:hover {
            background-color: #3367D6;
        }

        /* Iconos en los botones */
        button i {
            margin-right: 10px;
            font-size: 18px;
        }
    </style>
</head>
<body>
<div class="login-container">
  <h2>Iniciar Sesión</h2>
  <input id="email" type="email" placeholder="Correo"/>
  <input id="password" type="password" placeholder="Contraseña"/>
  <button id="btnLogin">Ingresar</button>
  <button id="btnGoogle" class="google-login-btn">Iniciar con Google</button>
  <button id="btnFingerprint">Ingresar con Huella</button>
  <p id="msg"></p>
</div>

<script type="module">
/* ========== CONFIG FIREBASE (REEMPLAZA CON TU CONFIG) ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
            apiKey: "AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80",
            authDomain: "login-de3fd.firebaseapp.com",
            databaseURL: "https://login-de3fd-default-rtdb.firebaseio.com",
            projectId: "login-de3fd",
            storageBucket: "login-de3fd.appspot.com",
            messagingSenderId: "1064113669692",
            appId: "1:1064113669692:web:c45b68b5a8a519536f2539",
            measurementId: "G-TMWR9JNR18"
        };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

/* ========== UTILS (base64url) ========== */
function bufferToBase64Url(buffer){
  const bytes = new Uint8Array(buffer);
  let str = '';
  for (let i=0;i<bytes.length;i++) str += String.fromCharCode(bytes[i]);
  return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function base64UrlToBuffer(base64url){
  let base64 = base64url.replace(/-/g,'+').replace(/_/g,'/');
  while (base64.length%4) base64 += '=';
  const bin = atob(base64);
  const len = bin.length;
  const bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return bytes.buffer;
}
function randomBase64Url(len=32){
  const a = new Uint8Array(len);
  crypto.getRandomValues(a);
  return bufferToBase64Url(a);
}

/* ========== ELEMENTOS UI ========== */
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const btnLogin = document.getElementById('btnLogin');
const btnGoogle = document.getElementById('btnGoogle');
const btnFingerprint = document.getElementById('btnFingerprint');
const msg = document.getElementById('msg');

/* ========== ENDPOINTS BACKEND ========== */
/* Cambia la URL base por la tuya (Cloud Function o servidor) */
const API_BASE = "https://us-central1-TU_PROJECT.cloudfunctions.net/webAuthn"; // ejemplo

async function postJson(url, body){
  const res = await fetch(url, {
    method: "POST",
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  return res.json();
}

/* ========== LOGIN EMAIL/PASS ====== */
btnLogin.onclick = async () => {
  const email = emailEl.value.trim();
  const password = passEl.value;
  if (!email || !password) { alert("completa"); return; }
  try {
    const resp = await signInWithEmailAndPassword(auth, email, password);
    // después de login exitoso, pedimos registrar credencial en servidor
    await registerCredentialOnServer(email);
    alert("Login OK y huella registrada (si aceptaste)");
    location.href = 'formulario.html';
  } catch (err) {
    alert("Error: " + err.message);
    console.error(err);
  }
};

/* ========== LOGIN GOOGLE ====== */
btnGoogle.onclick = async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const email = result.user.email;
    await registerCredentialOnServer(email);
    alert("Login Google OK");
    location.href = 'formulario.html';
  } catch (err) {
    console.error(err);
    alert("Error Google: " + err.message);
  }
};

/* ========== REGISTRAR CREDENCIAL EN SERVIDOR (ATTACHMENT) ========== */
async function registerCredentialOnServer(email){
  if (!window.PublicKeyCredential) { console.warn('WebAuthn no soportado'); return; }

  // 1) pedir opciones de registro al servidor
  const opts = await postJson(API_BASE + '/generate-registration-options', { email });
  // el servidor debe devolver challenge y options (we'll assume base64url fields)
  // convertimos los campos a ArrayBuffers
  opts.publicKey.challenge = base64UrlToBuffer(opts.publicKey.challenge);
  opts.publicKey.user.id = base64UrlToBuffer(opts.publicKey.user.id);

  // 2) navigator.credentials.create
  const credential = await navigator.credentials.create({ publicKey: opts.publicKey });

  // 3) preparar datos para servidor
  const attestation = {
    id: credential.id,
    rawId: bufferToBase64Url(credential.rawId),
    response: {
      clientDataJSON: bufferToBase64Url(credential.response.clientDataJSON),
      attestationObject: bufferToBase64Url(credential.response.attestationObject)
    },
    type: credential.type
  };

  // 4) enviar al servidor para verificar y guardar la credencial (server stores publicKey)
  const verification = await postJson(API_BASE + '/verify-registration', { email, attestation });
  if (!verification.success) {
    console.error('Registro falló:', verification);
    alert('No se pudo registrar huella: ' + (verification.error || 'error'));
  } else {
    console.log('Registro OK:', verification);
  }
}

/* ========== LOGIN CON HUELLA (ASSERTION) ====== */
btnFingerprint.onclick = async () => {
  try {
    // 1) pedir opciones de autenticación al servidor
    const opts = await postJson(API_BASE + '/generate-authentication-options', {});
    // servidor returns challenge and allowCredentials (ids base64url)
    opts.publicKey.challenge = base64UrlToBuffer(opts.publicKey.challenge);
    if (opts.publicKey.allowCredentials) {
      opts.publicKey.allowCredentials = opts.publicKey.allowCredentials.map(c => ({
        id: base64UrlToBuffer(c.id),
        type: c.type,
        transports: c.transports
      }));
    }

    // 2) navigator.credentials.get
    const assertion = await navigator.credentials.get({ publicKey: opts.publicKey });

    // 3) preparar la respuesta y enviar al servidor para verificar
    const authData = {
      id: assertion.id,
      rawId: bufferToBase64Url(assertion.rawId),
      response: {
        clientDataJSON: bufferToBase64Url(assertion.response.clientDataJSON),
        authenticatorData: bufferToBase64Url(assertion.response.authenticatorData),
        signature: bufferToBase64Url(assertion.response.signature),
        userHandle: assertion.response.userHandle ? bufferToBase64Url(assertion.response.userHandle) : null
      },
      type: assertion.type
    };

    const verification = await postJson(API_BASE + '/verify-authentication', { authData });
    if (!verification.success) {
      alert('Autenticación falló: ' + (verification.error || 'error'));
      return;
    }

    // servidor devuelve customToken de Firebase
    const customToken = verification.customToken;
    if (!customToken) {
      alert('No se recibió token para Firebase');
      return;
    }

    // 4) iniciar sesión con customToken en Firebase
    await signInWithCustomToken(auth, customToken);
    alert('Inicio con huella OK');
    location.href = 'formulario.html';
  } catch (err) {
    console.error(err);
    alert('Error huella: ' + (err.message || err));
  }
};
</script>
</body>
</html>
