<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login con Huella + Firebase</title>
  <link rel="icon" href="iconGaleria.png" type="image/png" />
  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#00c6ff,#0072ff);display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .card{background:#fff;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);width:100%;max-width:420px;text-align:center}
    h1{margin:0 0 12px;font-size:26px;color:#333}
    p{color:#666;margin:8px 0}
    input{width:100%;padding:14px;margin-top:10px;border:2px solid #ddd;border-radius:10px;font-size:16px}
    input:focus{outline:none;border-color:#007bff}
    .spinner{margin:14px auto;border:4px solid rgba(0,0,0,.1);border-top:4px solid #000;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .btn{background:#007bff;color:#fff;border:none;padding:12px;width:100%;border-radius:10px;font-size:16px;margin-top:10px;cursor:pointer;letter-spacing:.3px}
    .btn:hover{background:#0056b3}
    .muted{font-size:12px;color:#777}
  </style>
</head>
<body>
  <div class="card">
    <h1>MultiVault</h1>
    <p>Escribe tu correo y valida con tu huella</p>
    <input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" />
    <button id="btnLogin" class="btn">Continuar</button>
    <div id="loader" class="spinner hidden"></div>
    <p id="status" class="muted"></p>
  </div>

  <script type="module">
    // ===== Firebase =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80',
      authDomain: 'login-de3fd.firebaseapp.com',
      databaseURL: 'https://login-de3fd-default-rtdb.firebaseio.com',
      projectId: 'login-de3fd',
      storageBucket: 'login-de3fd.appspot.com',
      messagingSenderId: '1064113669692',
      appId: '1:1064113669692:web:c45b68b5a8a519536f2539',
      measurementId: 'G-TMWR9JNR18'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Constantes =====
    const API_BASE = 'https://us-central1-login-de3fd.cloudfunctions.net/webauthn';
    const FORM_URL = (location.hostname === 'ivanclas.github.io') ? '/MultiVault/formulario.html' : 'formulario.html';

    // ===== Helpers UI =====
    const $ = (id)=>document.getElementById(id);
    const setLoading = (on)=> $('loader').classList[on?'remove':'add']('hidden');
    const setStatus = (t)=> $('status').textContent = t || '';

    // ===== Helpers base64url <-> ArrayBuffer =====
    const b64urlToBuf = (b64url) => {
      const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
      const b64 = (b64url + pad).replace(/-/g,'+').replace(/_/g,'/');
      const bin = atob(b64);
      const buf = new ArrayBuffer(bin.length);
      const view = new Uint8Array(buf);
      for(let i=0;i<bin.length;i++) view[i] = bin.charCodeAt(i);
      return buf;
    };
    const bufToB64url = (buf) => {
      const bytes = new Uint8Array(buf);
      let str='';
      for(let i=0;i<bytes.byteLength;i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    };

    // ===== HTTP helper con diagnósticos =====
    async function postJSON(url, body){
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
        if(!res.ok){
          const text = await res.text().catch(()=>'(sin body)');
          throw new Error(`HTTP ${res.status} ${res.statusText} -> ${text}`);
        }
        return await res.json();
      }catch(e){
        console.error('postJSON error', e);
        throw e;
      }
    }

    // ===== Log en Firestore =====
    async function logLogin(method){
      try{
        const user = auth.currentUser;
        if(!user) return;
        await addDoc(collection(db,'loginLogs'),{
          uid: user.uid,
          email: user.email||null,
          method,
          at: serverTimestamp(),
          ua: navigator.userAgent
        });
      }catch(err){ console.warn('No se pudo registrar el inicio de sesión:', err?.message||err); }
    }

    // ===== Registro de Passkey para un correo =====
    async function registerPasskeyFor(email){
      setStatus('Registrando tu huella…');
      // 1) Pedir opciones de registro al backend
      const options = await postJSON(`${API_BASE}/api/webauthn/register/options`, { email });
      // Forzar lector del dispositivo (plataforma)
      options.authenticatorSelection = {
        authenticatorAttachment: 'platform',
        residentKey: options.authenticatorSelection?.residentKey || 'preferred',
        userVerification: 'required',
      };
      // Adaptar tipos
      options.challenge = b64urlToBuf(options.challenge);
      if(options.user?.id) options.user.id = b64urlToBuf(options.user.id);
      if(Array.isArray(options.excludeCredentials)){
        options.excludeCredentials = options.excludeCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
      }
      // 2) Crear credencial (aparece prompt de huella/FaceID)
      const cred = await navigator.credentials.create({ publicKey: options });
      if(!cred) throw new Error('No se pudo crear la credencial');
      // 3) Enviar al backend para verificar y guardar
      const attestation = {
        id: cred.id,
        rawId: bufToB64url(cred.rawId),
        type: cred.type,
        response: {
          clientDataJSON: bufToB64url(cred.response.clientDataJSON),
          attestationObject: bufToB64url(cred.response.attestationObject)
        }
      };
      await postJSON(`${API_BASE}/api/webauthn/register/verify`, { email, attestation });
      setStatus('Huella registrada. Ingresando…');
      // Después de registrar, autenticar inmediatamente
      await authenticateWithEmail(email);
    }

    // ===== Autenticación con Passkey para un correo =====
    async function authenticateWithEmail(email){
      setStatus('Validando con tu huella…');
      // 1) Pedir opciones de autenticación (allowCredentials por correo)
      const options = await postJSON(`${API_BASE}/api/webauthn/auth/options`, { email });
      options.challenge = b64urlToBuf(options.challenge);
      if(Array.isArray(options.allowCredentials)){
        options.allowCredentials = options.allowCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
      }
      // 2) Prompt de huella/FaceID
      const assertion = await navigator.credentials.get({ publicKey: options });
      if(!assertion) throw new Error('No se obtuvo credencial');
      // 3) Verificar en backend y obtener Custom Token
      const authData = {
        id: assertion.id,
        rawId: bufToB64url(assertion.rawId),
        type: assertion.type,
        response: {
          clientDataJSON: bufToB64url(assertion.response.clientDataJSON),
          authenticatorData: bufToB64url(assertion.response.authenticatorData),
          signature: bufToB64url(assertion.response.signature),
          userHandle: assertion.response.userHandle ? bufToB64url(assertion.response.userHandle) : null,
        }
      };
      const verify = await postJSON(`${API_BASE}/api/webauthn/auth/verify`, { email, assertion: authData });
      if(!verify?.firebaseCustomToken) throw new Error('Backend no devolvió Custom Token');
      // 4) Iniciar sesión en Firebase y redirigir
      await signInWithCustomToken(auth, verify.firebaseCustomToken);
      await logLogin('passkey');
      location.href = FORM_URL;
    }

    // ===== Al hacer click: pedir correo -> huella -> login (registrando si hace falta) =====
    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('email').value.trim();
      if(!email) return alert('Ingresa tu correo');
      if(!window.PublicKeyCredential) return alert('Tu navegador no soporta WebAuthn/Passkeys');
      setLoading(true); setStatus('Preparando autenticación…');
      try{
        // Intento de autenticación. Si falla por falta de passkey, registramos y luego autenticamos.
        try{
          await authenticateWithEmail(email);
        }catch(e){
          console.log('Auth falló, intentando registro:', e?.name, e?.message);
          await registerPasskeyFor(email);
        }
      }catch(err){
        console.error(err);
        alert('Error: ' + (err?.message || err));
        setStatus('');
      }finally{
        setLoading(false);
      }
    });
  </script>
</body>
</html>
