<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login con Huella + Firebase</title>
  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#00c6ff,#0072ff);display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .login-container{background:#fff;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);width:100%;max-width:420px;text-align:center}
    h2{margin:0 0 16px}
    input{width:100%;padding:14px;margin:8px 0;border:2px solid #ddd;border-radius:10px;font-size:16px;box-sizing:border-box}
    button{width:100%;padding:14px;margin-top:12px;border:0;border-radius:10px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;background:#007bff;color:#fff}
    button:hover{background:#0056b3}
    .google-btn{background:#4285F4}
    .google-btn:hover{background:#3367D6}
    .passkey{background:#111827}
    .passkey:hover{background:#0b1220}
    .hint{color:#666;font-size:12px;margin-top:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .spinner{display:none;margin:12px auto;border:4px solid rgba(0,0,0,.1);border-top:4px solid #000;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="login-container">
    <h2>Iniciar Sesión</h2>
    <input type="email" id="email" placeholder="Correo" autocomplete="username" />
    <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" />
    <button id="btn-login">Ingresar</button>
    <button id="btn-google" class="google-btn">Iniciar con Google</button>
    <div class="row">
      <button id="btn-register-passkey" class="passkey" style="display:none">Registrar Passkey</button>
      <button id="btn-login-passkey" class="passkey" style="display:none">Ingresar con Huella</button>
    </div>
    <div id="loader" class="spinner"></div>
    <div class="hint">Requiere navegador compatible (Chrome/Android o Safari/iOS) y HTTPS.</div>
  </div>

  <script type="module">
    // ===== Firebase (v11) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80',
      authDomain: 'login-de3fd.firebaseapp.com',
      databaseURL: 'https://login-de3fd-default-rtdb.firebaseio.com',
      projectId: 'login-de3fd',
      storageBucket: 'login-de3fd.appspot.com',
      messagingSenderId: '1064113669692',
      appId: '1:1064113669692:web:c45b68b5a8a519536f2539',
      measurementId: 'G-TMWR9JNR18'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ===== BACKEND URL (ajústala a tu Function deploy) =====
    // Ejemplo: https://us-central1-login-de3fd.cloudfunctions.net/webauthn
    const API_BASE = 'https://us-central1-login-de3fd.cloudfunctions.net/webauthn';

    // ===== Helpers base64url <-> ArrayBuffer =====
    const b64urlToBuf = (b64url) => {
      const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
      const b64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const str = atob(b64);
      const buf = new ArrayBuffer(str.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < str.length; i++) view[i] = str.charCodeAt(i);
      return buf;
    };
    const bufToB64url = (buf) => {
      const bytes = new Uint8Array(buf);
      let str = '';
      for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    // ===== UI =====
    const el = (id) => document.getElementById(id);
    const show = (id, on=true) => el(id).style.display = on ? 'inline-flex' : 'none';
    const loading = (on) => el('loader').style.display = on ? 'block' : 'none';

    const supportsWebAuthn = () => !!window.PublicKeyCredential;
    if (supportsWebAuthn()) {
      show('btn-register-passkey', true);
      show('btn-login-passkey', true);
    }

    // ===== API client =====
    async function postJSON(url, body){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // ===== Email/Password =====
    el('btn-login').addEventListener('click', async()=>{
      const email = el('email').value.trim();
      const password = el('password').value;
      if(!email || !password){ alert('Completa correo y contraseña'); return; }
      try{
        loading(true);
        await signInWithEmailAndPassword(auth, email, password);
        alert('Inicio de sesión exitoso');
        // (Opcional) ofrecer registrar passkey luego del login
        // window.location.href = 'formulario.html';
      }catch(err){ alert('Error: '+err.message); }
      finally{ loading(false); }
    });

    // ===== Google =====
    el('btn-google').addEventListener('click', async()=>{
      try{
        loading(true);
        await signInWithPopup(auth, provider);
        alert('Inicio con Google exitoso');
        // window.location.href = 'formulario.html';
      }catch(err){ alert('Error con Google: '+err.message); }
      finally{ loading(false); }
    });

    // ===== Registrar Passkey (huella/FaceID) =====
    el('btn-register-passkey').addEventListener('click', async()=>{
      try{
        if(!supportsWebAuthn()) return alert('Tu navegador no soporta WebAuthn/Passkeys.');
        const email = (el('email').value || auth.currentUser?.email || '').trim();
        if(!email) return alert('Ingresa tu correo o inicia sesión para asociar la passkey.');
        loading(true);
        const options = await postJSON(`${API_BASE}/api/webauthn/register/options`, { email });
        // Adaptar propiedades a ArrayBuffer
        options.challenge = b64urlToBuf(options.challenge);
        if(options.user?.id) options.user.id = b64urlToBuf(options.user.id);
        if(Array.isArray(options.excludeCredentials)){
          options.excludeCredentials = options.excludeCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
        }
        const cred = await navigator.credentials.create({ publicKey: options });
        if(!cred) throw new Error('No se pudo crear la credencial');
        const attestation = {
          id: cred.id,
          rawId: bufToB64url(cred.rawId),
          type: cred.type,
          response: {
            clientDataJSON: bufToB64url(cred.response.clientDataJSON),
            attestationObject: bufToB64url(cred.response.attestationObject)
          }
        };
        await postJSON(`${API_BASE}/api/webauthn/register/verify`, { email, attestation });
        alert('Passkey registrada. Ya puedes ingresar con huella.');
      }catch(err){ alert('Error registrando passkey: '+err.message); }
      finally{ loading(false); }
    });

    // ===== Ingresar con Huella (Passkey) =====
    el('btn-login-passkey').addEventListener('click', async()=>{
      try{
        if(!supportsWebAuthn()) return alert('Tu navegador no soporta WebAuthn/Passkeys.');
        const email = (el('email').value || auth.currentUser?.email || '').trim();
        loading(true);
        const options = await postJSON(`${API_BASE}/api/webauthn/auth/options`, { email: email || undefined });
        options.challenge = b64urlToBuf(options.challenge);
        if(Array.isArray(options.allowCredentials)){
          options.allowCredentials = options.allowCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
        }
        const assertion = await navigator.credentials.get({ publicKey: options });
        if(!assertion) throw new Error('No se obtuvo credencial');
        const authData = {
          id: assertion.id,
          rawId: bufToB64url(assertion.rawId),
          type: assertion.type,
          response: {
            clientDataJSON: bufToB64url(assertion.response.clientDataJSON),
            authenticatorData: bufToB64url(assertion.response.authenticatorData),
            signature: bufToB64url(assertion.response.signature),
            userHandle: assertion.response.userHandle ? bufToB64url(assertion.response.userHandle) : null,
          }
        };
        const verify = await postJSON(`${API_BASE}/api/webauthn/auth/verify`, { email: email || undefined, assertion: authData });
        if(!verify?.firebaseCustomToken) throw new Error('Backend no devolvió Custom Token');
        await signInWithCustomToken(auth, verify.firebaseCustomToken);
        alert('Huella verificada. Login OK');
        window.location.href = 'formulario.html';
      }catch(err){ alert('Error con huella: '+err.message); }
      finally{ loading(false); }
    });
  </script>
</body>
</html>
