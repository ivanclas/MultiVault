<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login con Huella + Firebase</title>
  <link rel="icon" href="iconGaleria.png" type="image/png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Estilos de tu login original, con pequeñas mejoras */
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #00c6ff, #0072ff); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
    .login-container { background-color: #fff; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; position: relative; }
    h1 { color: #333; font-size: 28px; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px; }
    input { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; transition: border-color 0.3s ease; box-sizing: border-box; position: relative; }
    input:focus { border-color: #007bff; outline: none; }
    .input-wrapper { position: relative; width: 100%; }
    .input-wrapper input { padding-right: 40px; }
    .toggle-password { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; width: 20px; height: 20px; }
    .toggle-password svg { fill: #999; width: 100%; height: 100%; }
    .toggle-password:hover svg { fill: #333; }
    button { width: 100%; padding: 15px; background-color: #007bff; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; margin-top: 12px; letter-spacing: 0.5px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    button:hover { background-color: #0056b3; }
    .google-login-btn { background-color: #4285F4; }
    .google-login-btn:hover { background-color: #3367D6; }
    .passkey-btn { background-color: #111827; }
    .passkey-btn:hover { background-color: #0b1220; }
    p { margin-top: 16px; color: #666; }
    a { color: #007bff; text-decoration: none; font-weight: bold; }
    a:hover { text-decoration: underline; }

    /* Modal */
    .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background-color: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; position: relative; }
    .modal-content h1 { margin-bottom: 20px; }
    .close { position: absolute; top: 10px; right: 20px; font-size: 30px; font-weight: bold; cursor: pointer; color: #999; }
    .close:hover { color: #333; }

    /* Overlay de carga */
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 50; }
    .loading-overlay p { color: white; font-size: 18px; margin-top: 10px; }
    .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    @media (max-width: 768px) { .login-container { padding: 30px; } h1 { font-size: 24px; } input, button { padding: 12px; font-size: 14px; } }
  </style>
</head>
<body>
  <div class="login-container">
    <h1>Iniciar Sesión</h1>

    <div class="input-wrapper">
      <input type="email" id="email" placeholder="Correo electrónico" autocomplete="username" required />
    </div>
    <div class="input-wrapper">
      <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" required />
      <span class="toggle-password" onclick="togglePassword('password')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5c-7.5 0-11 7.5-11 7.5s3.5 7.5 11 7.5 11-7.5 11-7.5-3.5-7.5-11-7.5zm0 12c-2.5 0-4.5-2-4.5-4.5s2-4.5 4.5-4.5 4.5 2 4.5 4.5-2 4.5-4.5 4.5zm0-7c-1.5 0-2.5 1-2.5 2.5s1 2.5 2.5 2.5 2.5-1 2.5-2.5-1-2.5-2.5-2.5z"/></svg>
      </span>
    </div>

    <button id="btn-login"><i class="fas fa-sign-in-alt"></i> Ingresar</button>
    <button id="btn-google" class="google-login-btn"><i class="fab fa-google"></i> Iniciar con Google</button>

    <!-- Nuevos: Passkeys -->
    <button id="btn-register-passkey" class="passkey-btn" style="display:none"><i class="fas fa-key"></i> Registrar Passkey</button>
    <button id="btn-login-passkey" class="passkey-btn" style="display:none"><i class="fas fa-fingerprint"></i> Ingresar con Huella</button>

    <p><a href="javascript:void(0);" id="link-reset">¿Olvidaste tu contraseña?</a></p>
    <p>¿No tienes una cuenta? <a href="javascript:void(0);" onclick="openModal()">Regístrate aquí</a>.</p>
  </div>

  <!-- Modal de registro -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h1>Registro</h1>
      <div class="input-wrapper">
        <input type="email" id="register-email" placeholder="Correo electrónico" required />
      </div>
      <div class="input-wrapper">
        <input type="password" id="register-password" placeholder="Contraseña" required />
        <span class="toggle-password" onclick="togglePassword('register-password')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5c-7.5 0-11 7.5-11 7.5s3.5 7.5 11 7.5 11-7.5 11-7.5-3.5-7.5-11-7.5zm0 12c-2.5 0-4.5-2-4.5-4.5s2-4.5 4.5-4.5 4.5 2 4.5 4.5-2 4.5-4.5 4.5zm0-7c-1.5 0-2.5 1-2.5 2.5s1 2.5 2.5 2.5 2.5-1 2.5-2.5-1-2.5-2.5-2.5z"/></svg>
        </span>
      </div>
      <button id="btn-register"><i class="fas fa-user-plus"></i> Registrar</button>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p>Por favor, espere...</p>
  </div>

  <script type="module">
    // ===== Firebase v11 =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signInWithCustomToken, sendPasswordResetEmail, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80',
      authDomain: 'login-de3fd.firebaseapp.com',
      databaseURL: 'https://login-de3fd-default-rtdb.firebaseio.com',
      projectId: 'login-de3fd',
      storageBucket: 'login-de3fd.appspot.com',
      messagingSenderId: '1064113669692',
      appId: '1:1064113669692:web:c45b68b5a8a519536f2539',
      measurementId: 'G-TMWR9JNR18'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ===== BACKEND URL =====
    const API_BASE = 'https://us-central1-login-de3fd.cloudfunctions.net/webauthn';

    // ===== Utils base64url <-> ArrayBuffer =====
    const b64urlToBuf = (b64url) => {
      const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
      const b64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const str = atob(b64);
      const buf = new ArrayBuffer(str.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < str.length; i++) view[i] = str.charCodeAt(i);
      return buf;
    };
    const bufToB64url = (buf) => {
      const bytes = new Uint8Array(buf);
      let str = '';
      for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    const loadingOverlay = document.getElementById('loadingOverlay');
    const showLoading = (on) => loadingOverlay.style.display = on ? 'flex' : 'none';

    const supportsWebAuthn = () => !!window.PublicKeyCredential;
    const btnRegPasskey = document.getElementById('btn-register-passkey');
    const btnLoginPasskey = document.getElementById('btn-login-passkey');
    if (supportsWebAuthn()) {
      btnRegPasskey.style.display = 'flex';
      btnLoginPasskey.style.display = 'flex';
    }

    // ===== API client =====
    async function postJSON(url, body){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // ===== Login Email/Password =====
    document.getElementById('btn-login').addEventListener('click', async()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ alert('Completa correo y contraseña'); return; }
      try{
        showLoading(true);
        await signInWithEmailAndPassword(auth, email, password);
        alert('Inicio de sesión exitoso');
        // window.location.href = 'formulario.html';
      }catch(err){ alert('Error: '+err.message); }
      finally{ showLoading(false); }
    });

    // ===== Login con Google =====
    document.getElementById('btn-google').addEventListener('click', async()=>{
      try{
        showLoading(true);
        await signInWithPopup(auth, provider);
        alert('Inicio con Google exitoso');
        // window.location.href = 'formulario.html';
      }catch(err){ alert('Error con Google: '+err.message); }
      finally{ showLoading(false); }
    });

    // ===== Reset password =====
    document.getElementById('link-reset').addEventListener('click', async()=>{
      const email = document.getElementById('email').value.trim();
      if(!email) return alert('Ingresa tu correo para restablecer la contraseña.');
      try{
        await sendPasswordResetEmail(auth, email);
        alert('Correo de restablecimiento enviado.');
      }catch(err){ alert('Error al enviar correo: '+err.message); }
    });

    // ===== Registro de usuario (modal) =====
    document.getElementById('btn-register').addEventListener('click', async()=>{
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      if(!email || !password){ alert('Completa los campos.'); return; }
      try{
        showLoading(true);
        await createUserWithEmailAndPassword(auth, email, password);
        alert('¡Registro exitoso!');
        closeModal();
        document.getElementById('register-email').value='';
        document.getElementById('register-password').value='';
      }catch(err){ alert('Error en el registro: '+err.message); }
      finally{ showLoading(false); }
    });

    // ===== Registrar Passkey =====
    btnRegPasskey.addEventListener('click', async()=>{
      try{
        if(!supportsWebAuthn()) return alert('Tu navegador no soporta WebAuthn/Passkeys.');
        const email = (document.getElementById('email').value || auth.currentUser?.email || '').trim();
        if(!email) return alert('Ingresa tu correo o inicia sesión para asociar la passkey.');
        showLoading(true);
        const options = await postJSON(`${API_BASE}/api/webauthn/register/options`, { email });
        options.challenge = b64urlToBuf(options.challenge);
        if(options.user?.id) options.user.id = b64urlToBuf(options.user.id);
        if(Array.isArray(options.excludeCredentials)){
          options.excludeCredentials = options.excludeCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
        }
        const cred = await navigator.credentials.create({ publicKey: options });
        if(!cred) throw new Error('No se pudo crear la credencial');
        const attestation = {
          id: cred.id,
          rawId: bufToB64url(cred.rawId),
          type: cred.type,
          response: {
            clientDataJSON: bufToB64url(cred.response.clientDataJSON),
            attestationObject: bufToB64url(cred.response.attestationObject)
          }
        };
        await postJSON(`${API_BASE}/api/webauthn/register/verify`, { email, attestation });
        alert('Passkey registrada. Ya puedes ingresar con huella.');
      }catch(err){ alert('Error registrando passkey: '+err.message); }
      finally{ showLoading(false); }
    });

    // ===== Login con Huella (Passkey) =====
    btnLoginPasskey.addEventListener('click', async()=>{
      try{
        if(!supportsWebAuthn()) return alert('Tu navegador no soporta WebAuthn/Passkeys.');
        const email = (document.getElementById('email').value || auth.currentUser?.email || '').trim();
        showLoading(true);
        const options = await postJSON(`${API_BASE}/api/webauthn/auth/options`, { email: email || undefined });
        options.challenge = b64urlToBuf(options.challenge);
        if(Array.isArray(options.allowCredentials)){
          options.allowCredentials = options.allowCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
        }
        const assertion = await navigator.credentials.get({ publicKey: options });
        if(!assertion) throw new Error('No se obtuvo credencial');
        const authData = {
          id: assertion.id,
          rawId: bufToB64url(assertion.rawId),
          type: assertion.type,
          response: {
            clientDataJSON: bufToB64url(assertion.response.clientDataJSON),
            authenticatorData: bufToB64url(assertion.response.authenticatorData),
            signature: bufToB64url(assertion.response.signature),
            userHandle: assertion.response.userHandle ? bufToB64url(assertion.response.userHandle) : null,
          }
        };
        const verify = await postJSON(`${API_BASE}/api/webauthn/auth/verify`, { email: email || undefined, assertion: authData });
        if(!verify?.firebaseCustomToken) throw new Error('Backend no devolvió Custom Token');
        await signInWithCustomToken(auth, verify.firebaseCustomToken);
        alert('Huella verificada. Login OK');
        window.location.href = 'formulario.html';
      }catch(err){ alert('Error con huella: '+err.message); }
      finally{ showLoading(false); }
    });

    // Exponer helpers globales para el modal y toggle
    window.togglePassword = (fieldId) => { const field = document.getElementById(fieldId); field.type = field.type === 'password' ? 'text' : 'password'; };
    window.openModal = () => { document.getElementById('registerModal').style.display = 'flex'; };
    window.closeModal = () => { document.getElementById('registerModal').style.display = 'none'; };
  </script>

  <script>
    // Registrar Service Worker como en tu implementación original
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then((registration) => { console.log('Service Worker registrado con éxito:', registration); })
          .catch((error) => { console.error('Error al registrar el Service Worker:', error); });
      });
    }
  </script>
</body>
</html>
