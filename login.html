<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login con Huella + Firebase (Auto)</title>
  <link rel="icon" href="iconGaleria.png" type="image/png" />
  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#00c6ff,#0072ff);display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .card{background:#fff;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);width:100%;max-width:420px;text-align:center}
    h1{margin:0 0 12px;font-size:26px;color:#333}
    p{color:#666;margin:8px 0}
    input{width:100%;padding:14px;margin-top:10px;border:2px solid #ddd;border-radius:10px;font-size:16px}
    input:focus{outline:none;border-color:#007bff}
    .hint{font-size:12px;color:#666;margin-top:8px}
    .spinner{margin:14px auto;border:4px solid rgba(0,0,0,.1);border-top:4px solid #000;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .hidden{display:none}
    .link{color:#007bff;cursor:pointer;font-weight:600}
  </style>
</head>
<body>
  <div class="card">
    <h1>MultiVault</h1>
    <p id="status">Verificando biometría…</p>
    <div id="loader" class="spinner"></div>

    <!-- Registro inicial (solo si no hay passkey) -->
    <div id="firstRun" class="hidden">
      <p><strong>Primera vez:</strong> escribe tu correo y toca Enter para registrar tu huella.</p>
      <input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" />
      <p class="hint">Se creará una <em>passkey</em> (huella/FaceID) vinculada a tu correo. Luego, en futuras visitas ingresarás automáticamente.</p>
      <p class="hint">Si prefieres contraseña ahora, <span id="usePassword" class="link">usa password</span>.</p>
      <div id="pwdBox" class="hidden">
        <input id="password" type="password" placeholder="Contraseña" autocomplete="current-password" />
      </div>
    </div>
  </div>

  <script type="module">
    // ===== Firebase v11 =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getFirestore, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80',
      authDomain: 'login-de3fd.firebaseapp.com',
      databaseURL: 'https://login-de3fd-default-rtdb.firebaseio.com',
      projectId: 'login-de3fd',
      storageBucket: 'login-de3fd.appspot.com',
      messagingSenderId: '1064113669692',
      appId: '1:1064113669692:web:c45b68b5a8a519536f2539',
      measurementId: 'G-TMWR9JNR18'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== BACKEND URL =====
    const API_BASE = 'https://us-central1-login-de3fd.cloudfunctions.net/webauthn';
    const FORM_URL = (location.hostname === 'ivanclas.github.io') ? '/MultiVault/formulario.html' : 'formulario.html';

    // ===== Helpers base64url <-> ArrayBuffer =====
    const b64urlToBuf = (b64url) => {
      const pad = '='.repeat((4 - (b64url.length % 4)) % 4);
      const b64 = (b64url + pad).replace(/-/g, '+').replace(/_/g, '/');
      const str = atob(b64);
      const buf = new ArrayBuffer(str.length);
      const view = new Uint8Array(buf);
      for (let i = 0; i < str.length; i++) view[i] = str.charCodeAt(i);
      return buf;
    };
    const bufToB64url = (buf) => {
      const bytes = new Uint8Array(buf);
      let str = '';
      for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    // ===== Utils UI =====
    const $ = (id) => document.getElementById(id);
    const show = (id, on=true) => $(id).classList[on? 'remove':'add']('hidden');
    const setStatus = (t) => { $('status').textContent = t; };

    async function postJSON(url, body){
      try {
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
        if(!res.ok){ const text = await res.text().catch(()=>'(sin body)'); throw new Error(`HTTP ${res.status} ${res.statusText} -> ${text}`); }
        return await res.json();
      } catch (e) {
        console.error('postJSON error', e);
        setStatus('No se pudo contactar con el servidor.');
        throw e;
      }
    }

    const supportsWebAuthn = () => !!window.PublicKeyCredential;

    // ====== Intento de login automático con Passkey (Conditional UI) ======
    async function tryAutoPasskeyLogin(){
      if (!supportsWebAuthn()) throw new Error('Navegador sin WebAuthn');
      setStatus('Buscando tu passkey…');
      // 1) Pedir opciones (sin email) → discoverable credentials
      const options = await postJSON(`${API_BASE}/api/webauthn/auth/options`, {});
      options.challenge = b64urlToBuf(options.challenge);
      if(Array.isArray(options.allowCredentials)){
        options.allowCredentials = options.allowCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
      }
      // Habilitar Conditional UI (autofill de passkeys)
      const publicKey = { ...options };
      // Algunos navegadores requieren pasar la propiedad directamente
      const assertion = await navigator.credentials.get({
        publicKey,
        mediation: 'conditional'
      });
      if(!assertion) throw new Error('Sin credencial');

      const authData = {
        id: assertion.id,
        rawId: bufToB64url(assertion.rawId),
        type: assertion.type,
        response: {
          clientDataJSON: bufToB64url(assertion.response.clientDataJSON),
          authenticatorData: bufToB64url(assertion.response.authenticatorData),
          signature: bufToB64url(assertion.response.signature),
          userHandle: assertion.response.userHandle ? bufToB64url(assertion.response.userHandle) : null,
        }
      };
      const verify = await postJSON(`${API_BASE}/api/webauthn/auth/verify`, { assertion: authData });
      if(!verify?.firebaseCustomToken) throw new Error('Backend no devolvió Custom Token');

      await signInWithCustomToken(auth, verify.firebaseCustomToken);
      await logLogin('passkey');
      location.href = FORM_URL;
    }

    // ====== Registro silencioso de passkey la primera vez ======
    async function registerPasskeyFor(email){
      setStatus('Registrando tu huella…');
      const options = await postJSON(`${API_BASE}/api/webauthn/register/options`, { email });
      // Forzar uso del lector del dispositivo
      options.authenticatorSelection = {
        authenticatorAttachment: 'platform',
        residentKey: options.authenticatorSelection?.residentKey || 'preferred',
        userVerification: 'required'
      };
      options.challenge = b64urlToBuf(options.challenge);
      if(options.user?.id) options.user.id = b64urlToBuf(options.user.id);
      if(Array.isArray(options.excludeCredentials)){
        options.excludeCredentials = options.excludeCredentials.map(c=>({ ...c, id: b64urlToBuf(c.id) }));
      }
      const cred = await navigator.credentials.create({ publicKey: options });
      if(!cred) throw new Error('No se pudo crear la credencial');
      const attestation = {
        id: cred.id,
        rawId: bufToB64url(cred.rawId),
        type: cred.type,
        response: {
          clientDataJSON: bufToB64url(cred.response.clientDataJSON),
          attestationObject: bufToB64url(cred.response.attestationObject)
        }
      };
      await postJSON(`${API_BASE}/api/webauthn/register/verify`, { email, attestation });
      setStatus('Huella registrada. Ingresando…');
      // Luego de registrar, iniciamos login automático
      await tryAutoPasskeyLogin();
    }

    // ===== Guardar registro del login en Firestore =====
    async function logLogin(method){
      try{
        const user = auth.currentUser;
        if(!user) return;
        await addDoc(collection(db, 'loginLogs'), {
          uid: user.uid,
          email: user.email || null,
          method,
          at: serverTimestamp(),
          ua: navigator.userAgent
        });
      }catch(e){ console.warn('No se pudo registrar el login:', e?.message || e); }
    }

    // ===== Flujo de arranque =====
    (async()=>{
      try{
        $('loader').style.display = 'block';
        await tryAutoPasskeyLogin();
      }catch(e){
        console.log('Auto-passkey fallo:', e?.name, e?.message);
        // Mostrar primer uso
        $('loader').style.display = 'none';
        setStatus('No encontramos una passkey asociada.');
        show('firstRun', true);
      }
    })();

    // ===== Interacciones mínimas (sin botones) =====
    const emailInput = $('email');
    const usePassword = $('usePassword');
    const pwdBox = $('pwdBox');

    if (emailInput) {
      emailInput.addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter'){
          const email = emailInput.value.trim();
          if(!email) return;
          try{
            $('loader').style.display = 'block';
            await registerPasskeyFor(email);
          }catch(err){
            $('loader').style.display = 'none';
            setStatus('No se pudo registrar la passkey: ' + (err?.message || err));
          }
        }
      });
    }

    if (usePassword) {
      usePassword.addEventListener('click', ()=>{
        show('pwdBox', true);
        emailInput?.focus();
      });
    }

    // Si el usuario escribe password y presiona Enter, hacemos login clásico 1 sola vez
    const pwdInput = $('password');
    if (pwdInput) {
      pwdInput.addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter'){
          const email = emailInput.value.trim();
          const pwd = pwdInput.value;
          if(!email || !pwd){ setStatus('Completa correo y contraseña'); return; }
          try{
            $('loader').style.display = 'block';
            await signInWithEmailAndPassword(auth, email, pwd);
            await logLogin('password');
            // tras el login, registra passkey automáticamente
            await registerPasskeyFor(email);
          }catch(err){
            $('loader').style.display = 'none';
            setStatus('Error de password: ' + (err?.message || err));
          }
        }
      });
    }
  </script>
</body>
</html>
