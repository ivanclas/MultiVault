<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login con Huella + Firebase</title>
  <link rel="icon" href="iconGaleria.png" type="image/png" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  :root { --bg: #f5f7fa; --panel:#fff; --text:#333; --muted:#757575; --primary:#007bff; --accent:#1e88e5; --danger:#e53935; }
  *{box-sizing:border-box}
  body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#00c6ff,#0072ff);display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;padding:20px}
  .login-container{background:#fff;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.15);width:100%;max-width:420px;text-align:center}
  h1{color:#333;font-size:26px;margin:0 0 14px}
  p.lead{color:#666;margin:0 0 18px;font-size:14px}
  .input-wrapper{position:relative;margin:10px 0}
  input{width:100%;padding:14px 14px;border:2px solid #ddd;border-radius:10px;font-size:15px}
  input:focus{outline:none;border-color:var(--primary)}
  button{width:100%;padding:14px;border:none;border-radius:10px;cursor:pointer;font-size:15px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px;transition:transform .15s}
  button:hover{transform:translateY(-1px)}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-google{background:#4285F4;color:#fff}
  .btn-fp{background:#111827;color:#fff}
  .divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:#888}
  .divider::before,.divider::after{content:"";height:1px;background:#e0e0e0;flex:1}
  .hint{font-size:12px;color:#666;margin-top:8px}
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 16px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .25s,transform .25s}
  .toast.show{opacity:1;transform:translate(-50%,-6px)}
</style>
</head>
</head>
<body>
  <div class="login-container">
    <h1>Iniciar Sesión</h1>
    <p class="lead">Usa tu correo/Google y registra tu huella para entrar rápido.</p>

    <div class="input-wrapper">
      <input type="email" id="email" placeholder="Correo" autocomplete="username" />
    </div>
    <div class="input-wrapper">
      <input type="password" id="password" placeholder="Contraseña" autocomplete="current-password" />
    </div>

    <button class="btn-primary" id="btnEmail">Ingresar</button>
    <div class="divider">o</div>
    <button class="btn-google" id="btnGoogle">Iniciar con Google</button>
    <button class="btn-fp" id="btnHuella">Ingresar con Huella</button>
    <div class="hint">La huella queda vinculada y podrás entrar sin contraseña mientras no cierres sesión desde la cuenta.</div>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyARefiao7-HrGUZJLNgxLZM1ouJZnf0i80",
    authDomain: "login-de3fd.firebaseapp.com",
    projectId: "login-de3fd",
    storageBucket: "login-de3fd.appspot.com",
    messagingSenderId: "1064113669692",
    appId: "1:1064113669692:web:c45b68b5a8a519536f2539"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  await setPersistence(auth, browserLocalPersistence);

  const $ = s => document.querySelector(s);
  const toast = $('#toast');
  const notify = m => { toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2200); };

  const emailEl = $('#email');
  const passEl  = $('#password');
  const btnEmail  = $('#btnEmail');
  const btnGoogle = $('#btnGoogle');
  const btnHuella = $('#btnHuella');
  const provider = new GoogleAuthProvider();

  // ========== WebAuthn helpers ==========

  const b64ToBytes = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const bytesToB64 = bytes => btoa(String.fromCharCode(...new Uint8Array(bytes)));

  async function registerPasskey(user) {
    try {
      const cred = await navigator.credentials.create({
        publicKey: {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          rp: { name: "Login rápido" },
          user: { id: new TextEncoder().encode(user.uid), name: user.email, displayName: user.email },
          pubKeyCredParams: [{ type:"public-key", alg:-7 }],
          authenticatorSelection: { authenticatorAttachment:"platform", userVerification:"required" },
          timeout: 15000,
          attestation: "none"
        }
      });
      const idB64 = bytesToB64(cred.rawId);
      localStorage.setItem("credentialId", idB64);
      localStorage.setItem("userEmail", user.email);
      notify("Huella registrada");
    } catch(e){ notify("Error registrando huella"); }
  }

  async function authWithPasskey(credentialIdB64) {
    try {
      const rawId = b64ToBytes(credentialIdB64);
      const assertion = await navigator.credentials.get({
        publicKey: {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          allowCredentials: [{ id: rawId, type:"public-key", transports:["internal"] }],
          userVerification: "required",
          timeout: 15000
        }
      });
      return !!assertion;
    } catch { return false; }
  }

  btnEmail.addEventListener("click", async ()=>{
    const email = emailEl.value.trim();
    const pass  = passEl.value;
    if(!email || !pass) return notify("Completa datos");
    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      if (!localStorage.getItem("credentialId")) registerPasskey(cred.user);
      location.href = "formulario.html";
    } catch(e){ notify("Error: "+e.message); }
  });

  btnGoogle.addEventListener("click", async ()=>{
    try {
      const res = await signInWithPopup(auth, provider);
      if (!localStorage.getItem("credentialId")) registerPasskey(res.user);
      location.href = "formulario.html";
    } catch(e){ notify("Error: "+e.message); }
  });

  btnHuella.addEventListener("click", async ()=>{
    const id = localStorage.getItem("credentialId");
    if (!id) return notify("No hay huella guardada");
    const ok = await authWithPasskey(id);
    if (ok) location.href = "formulario.html";
    else notify("Huella no verificada");
  });

  // Auto login si ya hay sesión y huella guardada
  onAuthStateChanged(auth, async user=>{
    if (user && localStorage.getItem("credentialId")) {
      const ok = await authWithPasskey(localStorage.getItem("credentialId"));
      if (ok) location.href = "formulario.html";
    }
  });
</script>
</body>
</html>
